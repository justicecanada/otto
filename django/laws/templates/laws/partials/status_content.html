{% load i18n %}

<!-- Hidden data for JavaScript -->
<script>
  // Update button states based on job status
  document.addEventListener('DOMContentLoaded', function() {
    updateButtonStates('{{ job_status.status }}');
  });
  
  function updateButtonStates(status) {
    const startBtn = document.getElementById('start-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    
    if (status === 'finished' || status === 'cancelled' || status === 'error') {
      if (startBtn) {
        startBtn.disabled = false;
      }
      if (cancelBtn) {
        cancelBtn.disabled = true;
      }
    } else {
      if (startBtn) {
        startBtn.disabled = true;
      }
      if (cancelBtn) {
        cancelBtn.disabled = false;
      }
    }
  }
  
  // Call this function after HTMX swaps
  updateButtonStates('{{ job_status.status }}');
</script>

<!-- Current Status Overview -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">{% trans "Job Status" %}</h5>
      </div>
      <div class="card-body">
        <p>
          <strong>{% trans "Status" %}:</strong>
          <span class="badge {% if job_status.status == 'finished' %}bg-success{% elif job_status.status == 'error' %}bg-danger{% elif job_status.status == 'cancelled' %}bg-secondary{% else %}bg-primary{% endif %}">
            {{ job_status.status|title }}
          </span>
        </p>
        <p>
          <strong>{% trans "Started" %}:</strong> {{ job_status.started_at }}
        </p>
        <p>
          <strong>{% trans "Finished" %}:</strong> {{ job_status.finished_at }}
        </p>
        <p>
          <strong>{% trans "Time Elapsed" %}:</strong> {{ job_status.elapsed }}
        </p>
        {% if job_status.error_message %}
          <p>
            <strong>{% trans "Error" %}:</strong> <span class="text-danger">{{ job_status.error_message }}</span>
          </p>
        {% endif %}
        <p>
          <strong>{% trans "Purged" %}:</strong> {{ job_status.purged_count }}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">{% trans "Progress Overview" %}</h5>
      </div>
      <div class="card-body">
        {% if stats.total > 0 %}
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span>{% trans "Overall Progress" %}</span>
              <span>{{ stats.finished|add:stats.empty|add:stats.error }}/{{ stats.total }}</span>
            </div>
            <div class="progress">
              <div class="progress-bar"
                   role="progressbar"
                   style="width: {{ stats.progress_percent }}%"
                   aria-valuenow="{{ stats.progress_percent }}"
                   aria-valuemin="0"
                   aria-valuemax="100">{{ stats.progress_percent }}%</div>
            </div>
          </div>

          <div class="row text-center">
            <div class="col-4">
              <div class="text-success">
                <strong>{{ stats.finished }}</strong>
                <br>
                <small>{% trans "Finished" %}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="text-warning">
                <strong>{{ stats.parsing|add:stats.embedding }}</strong>
                <br>
                <small>{% trans "Processing" %}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="text-danger">
                <strong>{{ stats.error }}</strong>
                <br>
                <small>{% trans "Errors" %}</small>
              </div>
            </div>
          </div>

          <div class="row text-center mt-2">
            <div class="col-4">
              <div class="text-muted">
                <strong>{{ stats.empty }}</strong>
                <br>
                <small>{% trans "Empty" %}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="text-info">
                <strong>{{ stats.pending }}</strong>
                <br>
                <small>{% trans "Pending" %}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="text-primary">
                <strong>{{ stats.parsing }}</strong>
                <br>
                <small>{% trans "Parsing" %}</small>
              </div>
            </div>
          </div>

          <div class="row text-center mt-2">
            <div class="col-12">
              <div class="text-warning">
                <strong>{{ stats.embedding }}</strong>
                <br>
                <small>{% trans "Embedding" %}</small>
              </div>
            </div>
          </div>
        {% else %}
          <p class="text-muted">{% trans "No laws to process" %}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Current Law Being Processed -->
{% if current_law.eng_law_id != "-" %}
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-gear-fill me-2"></i>
        {% trans "Currently Processing" %}
      </h5>
    </div>
    <div class="card-body">
      <h6>{{ current_law.eng_law_id }}</h6>
      <p class="mb-1">
        <strong>{% trans "Status" %}:</strong>
        <span class="badge bg-warning">{{ current_law.status|title }}</span>
      </p>
      {% if current_law.details %}<p class="mb-0 text-muted">{{ current_law.details }}</p>{% endif %}
    </div>
  </div>
{% endif %}

<!-- Recent Laws -->
{% if recent_laws %}
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">{% trans "Recent Laws" %}</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>{% trans "Law ID" %}</th>
              <th>{% trans "Status" %}</th>
              <th>{% trans "Details" %}</th>
              <th>{% trans "Error" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for law in recent_laws %}
              <tr {% if law.is_current %}class="table-primary"{% endif %}>
                <td>{{ law.eng_law_id }}</td>
                <td>
                  <span class="badge {% if law.status == 'finished' %}bg-success{% elif law.status == 'error' %}bg-danger{% elif law.status == 'empty' %}bg-secondary{% elif law.status == 'parsing_xml' or law.status == 'embedding_nodes' %}bg-warning{% else %}bg-info{% endif %}">
                    {{ law.status|title }}
                  </span>
                </td>
                <td>{{ law.details|truncatechars:50 }}</td>
                <td>
                  {% if law.error_message %}<span class="text-danger">{{ law.error_message|truncatechars:50 }}</span>{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}
