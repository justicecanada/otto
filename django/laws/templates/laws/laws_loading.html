{% extends 'base.html' %}
{% load i18n %}
{% load filters %}
{% load static %}

{% block breadcrumb %}
  {{ block.super }}
  <li class="breadcrumb-item">
    <a href="{% url 'laws:loading_monitor' %}">{% trans "Laws Loading Monitor" %}</a>
  </li>
{% endblock %}

{% block page_css %}
  <script src="{% static 'thirdparty/htmx.min.js' %}"></script>
  <style>
    .status-container {
      min-height: 400px;
    }
    .btn:disabled {
      cursor: not-allowed;
    }
    .card {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .progress {
      height: 20px;
    }
    .badge {
      font-size: 0.75em;
    }
  </style>
{% endblock %}

{% block page_title %}
  {% trans "Laws Loading Monitor - Otto" %}
{% endblock %}

{% block content_container %}
  <div id="laws-loading-outer">
    <div class="container py-3 px-0">
      <h2 class="mb-3 mt-2">{% trans "Laws Loading Monitor" %}</h2>

      <p class="text-muted">
        {% trans "Monitor, start and cancel the law loading process. This process downloads and processes Canadian legislation from the laws-lois-xml repository." %}
      </p>

      <!-- Control Panel -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">{% trans "Control Panel" %}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <!-- Start Job Form -->
              <form id="start-form"
                    hx-post="{% url 'laws:loading_start' %}"
                    hx-swap="none"
                    hx-indicator="#start-spinner">
                {% csrf_token %}
                <div class="row">
                  <div class="col-md-6">
                    <h6>{% trans "Load Options" %}</h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="small" id="small">
                      <label class="form-check-label" for="small">{% trans "Small (sample only)" %}</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="full" id="full">
                      <label class="form-check-label" for="full">{% trans "Full (all legislation)" %}</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             name="const_only"
                             id="const_only">
                      <label class="form-check-label" for="const_only">{% trans "Constitution only" %}</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h6>{% trans "Advanced Options" %}</h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="reset" id="reset">
                      <label class="form-check-label" for="reset">{% trans "Reset database" %}</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             name="force_download"
                             id="force_download">
                      <label class="form-check-label" for="force_download">{% trans "Force re-download" %}</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             name="force_update"
                             id="force_update">
                      <label class="form-check-label" for="force_update">{% trans "Force update existing" %}</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             name="mock_embedding"
                             id="mock_embedding">
                      <label class="form-check-label" for="mock_embedding">{% trans "Mock embedding (debug)" %}</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="debug" id="debug">
                      <label class="form-check-label" for="debug">{% trans "Debug mode" %}</label>
                    </div>
                  </div>
                </div>
              </form>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="d-grid gap-2 w-100">
                <button type="submit"
                        form="start-form"
                        class="btn btn-success btn-lg"
                        id="start-btn"
                        {% if job_status.status not in 'finished,cancelled,error' %}disabled{% endif %}>
                  <span id="start-spinner"
                        class="spinner-border spinner-border-sm d-none"
                        role="status"
                        aria-hidden="true"></span>
                  {% trans "Start Job" %}
                </button>
                <button type="button"
                        class="btn btn-danger btn-lg"
                        id="cancel-btn"
                        hx-post="{% url 'laws:loading_cancel' %}"
                        hx-confirm="{% trans 'Are you sure you want to cancel the running job?' %}"
                        hx-swap="none"
                        hx-indicator="#cancel-spinner"
                        {% if job_status.status in 'finished,cancelled,error' %}disabled{% endif %}>
                  <span id="cancel-spinner"
                        class="spinner-border spinner-border-sm d-none"
                        role="status"
                        aria-hidden="true"></span>
                  {% trans "Cancel Job" %}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Container - Auto-refreshes via HTMX -->
      <div id="status-container"
           class="status-container"
           hx-get="{% url 'laws:loading_status' %}"
           hx-trigger="load, every 2s"
           hx-swap="innerHTML">
        <!-- Initial status content will be loaded here -->
        {% include 'laws/partials/status_content.html' %}
      </div>

      <!-- All Laws Table (for detailed view) -->
      {% if law_loading_statuses %}
        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{% trans "All Laws (Detailed View)" %}</h5>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#all-laws-table"
                    aria-expanded="false">{% trans "Toggle" %}</button>
          </div>
          <div class="collapse" id="all-laws-table">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>{% trans "Law ID" %}</th>
                      <th>{% trans "Status" %}</th>
                      <th>{% trans "Started" %}</th>
                      <th>{% trans "Finished" %}</th>
                      <th>{% trans "Details" %}</th>
                      <th>{% trans "Error" %}</th>
                      <th>{% trans "Cost" %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for status in law_loading_statuses %}
                      <tr>
                        <td>{{ status.eng_law_id|default:"-" }}</td>
                        <td>
                          <span class="badge {% if status.status == 'finished' %}bg-success{% elif status.status == 'error' %}bg-danger{% elif status.status == 'empty' %}bg-secondary{% elif status.status == 'parsing_xml' or status.status == 'embedding_nodes' %}bg-warning{% else %}bg-info{% endif %}">
                            {{ status.status|title }}
                          </span>
                        </td>
                        <td>{{ status.started_at|date:"H:i:s" }}</td>
                        <td>{{ status.finished_at|date:"H:i:s"|default:"-" }}</td>
                        <td>{{ status.details|truncatechars:30|default:"-" }}</td>
                        <td>
                          {% if status.error_message %}
                            <span class="text-danger" title="{{ status.error_message }}">{{ status.error_message|truncatechars:30 }}</span>
                          {% else %}
                            -
                          {% endif %}
                        </td>
                        <td>{{ status.cost|floatformat:4|default:"0.0000" }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    // Handle form responses
    document.body.addEventListener('htmx:afterRequest', function(evt) {
      if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
        let response = JSON.parse(evt.detail.xhr.responseText);
        if (response.success) {
          // Show success message
          let alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success alert-dismissible fade show';
          alertDiv.innerHTML = `
            ${response.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h2').nextSibling);
          
          // Auto-dismiss after 5 seconds
          setTimeout(() => {
            alertDiv.remove();
          }, 5000);
          
          // Refresh status immediately
          htmx.trigger('#status-container', 'load');
        }
      } else {
        // Handle error response
        try {
          let response = JSON.parse(evt.detail.xhr.responseText);
          if (response.message) {
            let alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
              ${response.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h2').nextSibling);
          }
        } catch (e) {
          console.error('Error parsing response:', e);
        }
      }
    });

    // Update button states based on job status
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.detail.target.id === 'status-container') {
        // This would require us to pass the job status in a way that JavaScript can access
        // For now, we'll handle this in the template
      }
    });
  </script>
{% endblock %}
