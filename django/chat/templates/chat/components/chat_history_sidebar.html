{% load i18n %}
<div id="left-sidebar"
     class="chat-sidebar bg-light hidden"
     aria-label='{% trans "Chat history" %}'>
  <div class="border-end h-100 overflow-hidden d-flex flex-column">
    <div id="new-chat-button-outer">
      <div class="offcanvas-header d-flex align-items-center gap-2 p-3 pb-2">
        <a class="btn btn-outline-dark new-chat-btn fw-semibold flex-grow-1 text-start"
           id="new-chat-button"
           href="{% url 'chat:new_chat' %}">
          <i class="bi bi-plus-square me-2"></i>
          {% trans "New chat" %}
        </a>
        <button type="button"
                id="chat-search-toggle"
                class="btn btn-sm d-flex align-items-center justify-content-center"
                style="width:2rem;
                       height:2rem"
                aria-label="{% trans 'Show search' %}">
          <i class="bi bi-search" aria-hidden="true"></i>
        </button>

        <button type="button"
                class="btn-close"
                id="close-left-sidebar"
                aria-controls="left-sidebar"
                style="margin-top: -4px"
                aria-label='{% trans "Close" %}'></button>
      </div>
      <div id="chat-search-container" class="px-3 pb-2 " style="display:none;">
        <div class="input-group input-group-sm">
          <input type="hidden"
                 name="current_chat_id"
                 id="current-chat-hidden-field"
                 value="{{ chat.id }}">
          <input type="text"
                 class="form-control border-none"
                 placeholder="{% trans 'Search...' %}"
                 aria-label="{% trans 'Search...' %}"
                 id="chat-history-search-input"
                 name="search"
                 autocomplete="off"
                 value="{{ search|default:'' }}"
                 hx-get="{% url 'chat:search_chats' %}"
                 hx-include="#current-chat-hidden-field"
                 hx-trigger="input delay:300ms, keyup changed"
                 hx-target="#chat-history-list"
                 hx-swap="outerHTML">
          <button type="button"
                  class="btn btn-outline-secondary"
                  id="chat-search-clear"
                  aria-label="{% trans 'Clear search' %}"
                  style="display:none"
                  onclick="document.getElementById('chat-history-search-input').value=''; document.getElementById('chat-history-search-input').dispatchEvent(new Event('input'))">
            <i class="bi bi-x" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="overflow-y-auto overflow-x-hidden p-3 pt-0 flex-grow-1"
         id="chat-history-list">
      {% with current_chat_id=chat.id %}
        {% include 'chat/components/chat_history_list_inner.html' %}
      {% endwith %}
    </div>
    <div class="p-3">
      <button type="button"
              class="btn btn-outline-danger btn-outline-initially-black w-100 position-relative"
              id="delete-all-chats"
              hx-target="#chat-history-list"
              hx-post="{% url 'chat:delete_all_chats' %}"
              hx-indicator="#delete-spinner"
              hx-confirm='{% trans "Are you sure you want to delete all chats? This action is irreversible." %}'>
        <span class="d-flex justify-content-center align-items-center">
          <i class="bi bi-trash me-2"></i>
          <span>{% trans "Delete all chats" %}</span>
        </span>
        <div id="delete-spinner"
             class="spinner position-absolute top-50 end-0 translate-middle-y me-3">
          <span class="spinner-border spinner-border-sm ms-2" aria-hidden="true"></span>
          <span class="visually-hidden" role="status">{% trans "Loading" %}</span>
        </div>
      </button>
    </div>
  </div>
</div>

{% block page_script %}
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    scrollToListItem();
    const toggleBtn = document.getElementById('chat-search-toggle');
    const container = document.getElementById('chat-search-container');
    const input = document.getElementById('chat-history-search-input');
    const clearBtn = document.getElementById('chat-search-clear');
    if (toggleBtn && container && input) {
      // If arriving with ?search= in URL, apply it and show search box
      const params = new URLSearchParams(window.location.search);
      const initialSearch = params.get('search');
      if (initialSearch) {
        container.style.display = '';
        input.value = initialSearch;
        clearBtn.style.display = '';
        // Trigger HTMX search to render filtered list
        input.dispatchEvent(new Event('input', { bubbles: true }));
        toggleBtn.setAttribute('aria-label', '{% trans 'Hide search' %}');
      }
      toggleBtn.addEventListener('click', () => {
        const visible = container.style.display !== 'none';
        if (!visible) {
          container.style.display = '';
          input.focus();
          toggleBtn.setAttribute('aria-label', '{% trans 'Hide search' %}');
        } else {
          container.style.display = 'none';
          input.value = '';
          clearBtn.style.display = 'none';
          toggleBtn.setAttribute('aria-label', '{% trans 'Show search' %}');
        }
      });
      input.addEventListener('input', () => {
        clearBtn.style.display = input.value ? '' : 'none';
        // If cleared manually (e.g., backspace to empty), trigger HTMX to restore full list
        if (!input.value) {
          // Let HTMX send the request (empty query) to search endpoint which should return full list
          input.dispatchEvent(new Event('keyup', { bubbles: true }));
        }
      });
      clearBtn.addEventListener('click', () => {
        input.value = '';
        clearBtn.style.display = 'none';
        // Trigger HTMX to reload full list
        input.dispatchEvent(new Event('keyup', { bubbles: true }));
        input.focus();
      });
    }
  });
  </script>
{% endblock %}
