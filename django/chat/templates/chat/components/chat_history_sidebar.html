{% load i18n %}
<div id="left-sidebar"
     class="chat-sidebar bg-light hidden"
     aria-label='{% trans "Chat history" %}'>
  <div class="border-end h-100 overflow-hidden d-flex flex-column">
    <div id="new-chat-button-outer">
      <div class="offcanvas-header d-flex align-items-center gap-2 p-3 pb-2">
        <a class="btn btn-outline-dark new-chat-btn fw-semibold flex-grow-1 text-start"
           id="new-chat-button"
           href="{% url 'chat:new_chat' %}">
          <i class="bi bi-plus-square me-2"></i>
          {% trans "New chat" %}
        </a>
        <button type="button"
                id="chat-search-toggle"
                class="btn d-flex align-items-center justify-content-center py-0 px-2 text-secondary"
                style="margin-top: -3px"
                aria-label="{% trans 'Show search' %}">
          <i class="bi bi-search" aria-hidden="true"></i>
        </button>
        <button type="button"
                class="btn-close"
                id="close-left-sidebar"
                aria-controls="left-sidebar"
                style="margin-top: -4px"
                aria-label='{% trans "Close" %}'></button>
      </div>
      <input type="hidden"
             name="current_chat_id"
             id="current-chat-hidden-field"
             value="{{ chat.id }}">
      <div id="chat-search-container"
           class="px-2 pb-2 pt-1 me-2"
           style="display:none">
        {# <div class="input-group input-group-sm px-1"> #}
        <input type="text"
               class="form-control form-control-sm border-none mx-1"
               placeholder="{% trans 'Search...' %}"
               aria-label="{% trans 'Search...' %}"
               id="chat-history-search-input"
               name="search"
               autocomplete="off"
               value="{{ search|default:'' }}"
               hx-get="{% url 'chat:search_chats' %}"
               hx-include="#current-chat-hidden-field"
               hx-trigger="input delay:300ms, keyup changed"
               hx-target="#chat-history-list"
               hx-swap="outerHTML">
        {# </div> #}
        {% comment %}
          <button type="button" class="btn btn-outline-secondary" id="chat-search-clear" aria-label="{% trans 'Clear search' %}" onclick="document.getElementById('chat-history-search-input').value=''; document.getElementById('chat-history-search-input').dispatchEvent(new Event('input'))">
            <i class="bi bi-x" aria-hidden="true"></i>
          </button>
        {% endcomment %}
      </div>
    </div>
    {% include 'chat/components/chat_history_list_container.html' with chat_history_sections=chat_history_sections search=search current_chat_id=chat.id %}
    <div class="p-3">
      <button type="button"
              class="btn btn-outline-danger btn-outline-initially-black w-100 position-relative"
              id="delete-all-chats"
              hx-target="#chat-history-list"
              hx-post="{% url 'chat:delete_all_chats' %}"
              hx-indicator="#delete-spinner"
              hx-confirm='{% trans "Are you sure you want to delete all chats? This action is irreversible." %}'>
        <span class="d-flex justify-content-center align-items-center">
          <i class="bi bi-trash me-2"></i>
          <span>{% trans "Delete all chats" %}</span>
        </span>
        <div id="delete-spinner"
             class="spinner position-absolute top-50 end-0 translate-middle-y me-3">
          <span class="spinner-border spinner-border-sm ms-2" aria-hidden="true"></span>
          <span class="visually-hidden" role="status">{% trans "Loading" %}</span>
        </div>
      </button>
    </div>
  </div>
</div>

{% block page_script %}
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    scrollToListItem();
    const toggleBtn = document.getElementById('chat-search-toggle');
    const container = document.getElementById('chat-search-container');
    const input = document.getElementById('chat-history-search-input');
    const clearBtn = document.getElementById('chat-search-clear');
    
    if (toggleBtn && container && input) {
      // Helper function to update button state based on search visibility
      const updateButtonState = () => {
        const searchVisible = container.style.display !== 'none';
        if (searchVisible) {
          toggleBtn.classList.remove('text-secondary');
          toggleBtn.classList.add('text-dark');
        } else {
          toggleBtn.classList.remove('text-dark');
          toggleBtn.classList.add('text-secondary');
        }
      };

      // Add hover effects that respect the current state
      toggleBtn.addEventListener('mouseenter', () => {
        const searchVisible = container.style.display !== 'none';
        if (!searchVisible) {
          toggleBtn.classList.remove('text-secondary');
          toggleBtn.classList.add('text-dark');
        }
      });

      toggleBtn.addEventListener('mouseleave', () => {
        updateButtonState(); // Restore proper state based on search visibility
      });

      // Helper function to hide search and reset state
      const hideSearchAndReset = () => {
        container.style.display = 'none';
        input.value = '';
        const url = new URL(window.location);
        url.searchParams.delete('search');
        url.hash = ''; // Remove hash fragment
        window.history.replaceState({}, '', url); 
        // Clear all search highlights from messages
        const messagesContainer = document.querySelector('#messages-container');
        if (messagesContainer) {
          unmarkInElement(messagesContainer);
        }
        // Trigger HTMX to reload full list
        input.dispatchEvent(new Event('keyup', { bubbles: true }));
        toggleBtn.setAttribute('aria-label', '{% trans 'Show search' %}');
        updateButtonState(); // Update button state
      };

      // Helper function to show search
      const showSearch = () => {
        container.style.display = '';
        input.focus();
        toggleBtn.setAttribute('aria-label', '{% trans 'Hide search' %}');
        updateButtonState(); // Update button state
      };

      // If arriving with ?search= in URL, apply it and show search box
      const params = new URLSearchParams(window.location.search);
      const initialSearch = params.get('search');
      if (initialSearch) {
        showSearch();
        input.value = initialSearch;
        // If server already rendered search results, skip triggering HTMX to avoid flicker
        const listEl = document.getElementById('chat-history-list');
        const alreadySearchRendered = listEl && listEl.dataset && listEl.dataset.searchActive === 'true';
        if (!alreadySearchRendered) {
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
      } else {
        // Initialize button state for when search is not visible
        updateButtonState();
      }

      toggleBtn.addEventListener('click', () => {
        const visible = container.style.display !== 'none';
        if (!visible) {
          showSearch();
        } else {
          hideSearchAndReset();
        }
      });

      input.addEventListener('input', () => {
        // If cleared manually (e.g., backspace to empty), trigger HTMX to restore full list
        if (!input.value) {
          // Let HTMX send the request (empty query) to search endpoint which should return full list
          input.dispatchEvent(new Event('keyup', { bubbles: true }));
        }
      });

      if (clearBtn) {
        clearBtn.addEventListener('click', hideSearchAndReset);
      }

      // Pressing "escape" within the input box hides it
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hideSearchAndReset();
        }
      });
    }
  });
  </script>
{% endblock %}
