{% load i18n %}

{% comment %}
  Check if message.text already contains rendered file content to avoid duplication.
  This happens when errors occur and the generator yields pre-rendered file status.
{% endcomment %}
{% if message.text and "files translated:" in message.text %}
  {% comment %}Message text already contains rendered file content, just display it{% endcomment %}
  {{ message.text|safe }}
{% else %}
  {% comment %}Normal case - render the file status and list{% endcomment %}
  <p class="mb-2">
    {% if message.is_bot %}
      {{ message.num_files }}/{{ message.parent.num_files }} {% trans "files translated:" %}
    {% else %}
      {{ message.num_files }}
      {% if message.num_files == 1 %}
        {% trans "file uploaded" %}
      {% else %}
        {% trans "files uploaded" %}
      {% endif %}
    {% endif %}
    {% if message.mode == "translate" and not message.is_bot %}
      {% trans "for translation:" %}
    {% elif message.mode == "qa" %}
      {% trans "for Q&A:" %}
    {% elif message.mode == "summarize" %}
      {% trans "for summarization:" %}
    {% endif %}
  </p>

  {% comment %}
    Show any additional content (like error messages) for bot messages
    when there are no translated files but there was supposed to be translation
  {% endcomment %}
  {% if message.is_bot and message.text and message.num_files == 0 and message.parent.num_files > 0 %}
    {{ message.text|safe }}
  {% endif %}

  <ul class="list-unstyled mb-1">
    {% for file in message.sorted_files %}
      <li class="message-file">
        <i class="bi bi-paperclip img-thumbnail-md img-icon-sm mx-1"></i>
        {% if file.saved_file %}
          <a href="{% url 'chat:download_file' file_id=file.id %}"
             class="text-body">{{ file.filename }}</a>
        {% else %}
          <span title="{% trans 'Chat files are deleted after 7 days' %}">{{ file.filename }} ({% trans "deleted" %})</span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% if message.mode == "translate" and message.is_bot and message.sorted_files|length > 1 %}
    <button class="mt-2 mb-1 btn btn-sm btn-outline-dark"
            onclick="downloadMessageFiles(this)">{% trans 'Download all files' %}</button>
  {% endif %}
{% endif %}

<script>
  if (!window.downloadMessageFiles) {
    window.downloadMessageFiles = function(btn) {
      const ul = (btn.previousElementSibling && btn.previousElementSibling.matches('ul.list-unstyled'))
        ? btn.previousElementSibling
        : btn.parentElement.querySelector('ul.list-unstyled');
      if (!ul) return;

      const anchors = Array.from(ul.querySelectorAll('a[href]'));
      if (!anchors.length) return;

      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'Preparing...';

      anchors.forEach(a => { try { a.setAttribute('download', ''); } catch(e){} });

      anchors.forEach((a, i) => {
        setTimeout(() => {
          try { a.click(); } catch(e) { window.open(a.href, '_blank'); }
          if (i === anchors.length - 1) {
            btn.disabled = false;
            btn.textContent = original;
          }
        }, i * 250);
      });
    }
      }
</script>
