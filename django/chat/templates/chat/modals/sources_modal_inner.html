{% load i18n %}
<div class="accordion accordion-flush"
     id="sources-{{ message_id }}-accordion">
  {% for source in sources %}

    <div class="accordion-item" data-group="{{ source.group_number }}">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#sources-{{ message_id }}-text-{{ forloop.counter }}"
                aria-expanded="false"
                aria-controls="sources-{{ message_id }}-text-{{ forloop.counter }}">
          <span class="me-1">[{{ forloop.counter }}]</span>
          {{ source.citation|safe }}
        </button>
      </h2>
      <div id="sources-{{ message_id }}-text-{{ forloop.counter }}"
           class="accordion-collapse collapse">
        <div class="accordion-body scrolling-content" style="">
          {% if source.document %}{{ source.document.href_button|safe }}{% endif %}
          {{ source.node_text|safe }}
        </div>
      </div>
    </div>
  {% endfor %}
</div>
<button id="expand-all-sources"
        hx-swap-oob="true"
        type="button"
        onclick="expandAllSources({{ message_id }})"
        class="btn btn-outline-dark mx-2"
        style="white-space: nowrap">
  <span id="expand-all-label"><i class="bi bi-chevron-double-down me-1"></i>{% trans "Expand all" %}</span>
  <span id="collapse-all-label" class="d-none"><i class="bi bi-chevron-double-up me-1"></i>{% trans "Collapse all" %}</span>
</button>

<button id="highlight-all-sources"
        type="button"
        hx-swap-oob="true"
        hx-get="{% url 'chat:message_sources_highlight' message_id=message_id %}?highlight=true"
        hx-target="#sources-modal-inner"
        hx-swap="innerHTML"
        hx-indicator="#sources-modal-spinner"
        class="btn btn-outline-dark mx-2"
        style="white-space: nowrap">
  <span id="highlight-all-label"><i class="bi bi-pencil me-1"></i>{% trans "Highlight sources" %}</span>
 
</button>
<script>
  (function () {
    let accordionItems = document.querySelectorAll("sources-{{ message_id }}-accordion .accordion-item");
    let lastGroup = null;

    let uniqueGroups = new Set();
    for (let item of accordionItems) {
        uniqueGroups.add(item.getAttribute("data-group"));
    }
    if (uniqueGroups.size === accordionItems.length) return;

    accordionItems.forEach((item, index) => {
        let currentGroup = item.getAttribute("data-group");

        // Check if we need to insert an hr before the current item
        if (lastGroup !== currentGroup && index !== 0) {
            let hr = document.createElement("hr");
            hr.style.border = "1px solid";
            hr.style.margin = "0px";
            item.parentNode.insertBefore(hr, item);
        }
        lastGroup = currentGroup;
    });
  })();
</script>
