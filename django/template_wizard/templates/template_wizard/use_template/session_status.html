{% load i18n %}

<h5 class="mb-3">{% trans "Processing status" %}</h5>
<ul class="list-group" id="session-status-list">
  {% for source in session.sources.all %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold truncate-start">
          {% if source.filename %}
            {{ source.filename }}
          {% elif source.url %}
            {{ source.url }}
          {% endif %}
        </div>
      </div>
      <div class="d-flex align-items-center justify-content-between mt-2 min-h-row">
        <span class="badge {% if source.status == 'pending' %}bg-secondary {% elif source.status == 'error' %}bg-danger {% elif source.status == 'completed' %}bg-success {% else %}bg-light text-dark {% endif %} rounded-pill">
          {{ source.get_status_display }}
        </span>
        {% if source.status != 'pending' and source.status != 'completed' and source.status != 'error' %}
          <span class="align-middle ms-2"><i class="bi bi-arrow-repeat text-primary small icn-spinner"
   aria-hidden="true"></i></span>
        {% endif %}
        <div class="ms-auto d-flex align-items-center gap-1 min-h-btns">
          {% if source.status == 'completed' %}
            <a class="btn btn-sm btn-outline-secondary d-flex align-items-center"
               title="{% trans 'Extracted data' %}"
               hx-get="{% url 'template_wizard:source_raw_data' session_id=session.id source_id=source.id %}"
               hx-target="#preview-result"
               hx-swap="innerHTML">
              <i class="bi bi-code-square me-1"></i> <span class="small">{% trans 'Extracted data' %}</span>
            </a>
            <a class="btn btn-sm btn-outline-primary d-flex align-items-center template-result-btn"
               title="{% trans 'Template result' %}"
               hx-get="{% url 'template_wizard:source_template_result' session_id=session.id source_id=source.id %}"
               hx-target="#preview-result"
               hx-swap="innerHTML">
              <i class="bi bi-file-earmark-text me-1"></i> <span class="small">{% trans 'Template result' %}</span>
            </a>
          {% elif source.status == 'error' %}
            <a class="btn btn-sm btn-outline-success d-flex align-items-center"
               title="{% trans 'Restart processing' %}"
               hx-get="{% url 'template_wizard:restart_source_processing' session_id=session.id source_id=source.id %}"
               hx-target="#session-status"
               hx-swap="innerHTML">
              <i class="bi bi-arrow-clockwise me-1"></i> <span class="small">{% trans 'Restart processing' %}</span>
            </a>
          {% else %}
            <span class="invisible" style="display:inline-block; min-width: 120px;">&nbsp;</span>
          {% endif %}
        </div>
      </div>
    </li>
  {% endfor %}
</ul>

{% if session.sources.all|dictsort:'status'|yesno:'completed,' %}
  {% with completed_sources=session.sources.all|dictsort:'status' %}
    {% if completed_sources|length > 0 and completed_sources.0.status == 'completed' %}
      <div class="mt-3">
        <a class="btn btn-outline-dark btn-sm"
           href="{% url 'template_wizard:download_all_results' session_id=session.id %}">
          <i class="bi bi-download"></i> {% trans "Download all results (.zip)" %}
        </a>
      </div>
    {% endif %}
  {% endwith %}
{% endif %}

{% if poll %}
  {# Start/continue polling #}
  <div id="session_status_poller"
       hx-get="{% url 'template_wizard:poll_status' session_id=session.id %}"
       hx-trigger="every 2s"
       hx-target="#session-status"
       hx-swap="innerHTML"
       hx-swap-oob="true"></div>
{% else %}
  {# Stop polling #}
  <div id="session_status_poller" hx-swap-oob="true"></div>
{% endif %}
