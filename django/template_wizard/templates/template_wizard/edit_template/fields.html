{% load i18n %}

<div class="row">
  <div class="col-xl-5 border-end">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>{% trans "Fields to extract" %}</h4>
      <div>
        <div class="d-inline-block me-2"
             style="position: relative;
                    top: 10px;
                    margin-top: -10px">
          <div id="generate-fields-spinner" class="spinner text-primary">
            <span class="spinner-border" aria-hidden="true"></span>
            <span class="visually-hidden" role="status">{% trans "Loading" %}</span>
          </div>
        </div>
        {% include "template_wizard/edit_template/field_generate_dropdown.html" with example_template=template.example_template example_sources=template.example_sources %}
        <button type="button"
                class="btn btn-success"
                data-bs-toggle="modal"
                data-bs-target="#fieldModal"
                hx-get="{% url 'template_wizard:field_modal' template_id=template.id %}"
                hx-target="#fieldModal .modal-content"
                hx-swap="innerHTML"
                onclick="document.querySelector('#fieldModal .modal-content').innerHTML = ''">
          {% trans "Add field" %}
        </button>
      </div>
    </div>
    <div class="mb-3" id="field-list">
      {% with template.fields.all as fields %}
        {% include "template_wizard/edit_template/field_list.html" %}
      {% endwith %}
    </div>
    <div class="text-muted small mb-3">
      {% trans "Note: Template name and description also influence the extraction results." %}
    </div>
    <form id="modify-fields-form"
          hx-post="{% url 'template_wizard:modify_fields' template_id=template.id %}"
          hx-target="#field-list"
          hx-swap="innerHTML"
          hx-indicator="#generate-fields-spinner"
          method="post">
      {% csrf_token %}
      <label for="modification_instruction" class="form-label visually-hidden">{% trans "Modify fields using Otto" %}</label>
      <div class="input-group mb-3">
        <input type="text"
               name="modification_instruction"
               id="modification_instruction"
               class="form-control"
               placeholder="{% trans 'Instruct Otto to modify the fields...' %}"
               aria-label="Modification instruction"
               required>
        <button class="btn btn-outline-primary" type="submit">{% trans "Modify fields" %}</button>
      </div>
    </form>
  </div>

  <div class="col-xl-7">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>{% trans "Results on example source" %}</h4>
      <div>
        <div class="d-inline-block me-2"
             style="position: relative;
                    top: 10px;
                    margin-top: -10px">
          <div id="test-fields-spinner" class="spinner text-primary">
            <span class="spinner-border" aria-hidden="true"></span>
            <span class="visually-hidden" role="status">{% trans "Loading" %}</span>
          </div>
        </div>
        {% include "template_wizard/edit_template/test_fields_dropdown.html" %}
      </div>
    </div>
    <div id="test-fields">{% include "template_wizard/edit_template/test_fields_fragment.html" %}</div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade"
     id="fieldModal"
     tabindex="-1"
     aria-labelledby="fieldModalLabel"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Modal content loaded here by HTMX -->
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col text-end">
    <a class="btn btn-primary"
       href="{% url 'template_wizard:edit_layout' template.id %}">
      {% trans "Next" %}<i class="bi bi-chevron-right ms-2"></i>
    </a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var testBtn = document.querySelector('button[hx-get][hx-target="#test-fields"]');
  if (testBtn) {
    testBtn.addEventListener('click', function(event) {
      if (!document.querySelectorAll('#field-list li button').length) {
        alert("{% trans 'You must add fields before testing extraction.' %}");
        event.preventDefault();
        event.stopImmediatePropagation();
        return false;
      }
    }, true); // useCapture=true
  }

  // Clear the modify fields form after HTMX request
  var modifyForm = document.getElementById('modify-fields-form');
  if (modifyForm) {
    modifyForm.addEventListener('htmx:afterRequest', function(event) {
      modifyForm.reset();
    });
  }
});
</script>
