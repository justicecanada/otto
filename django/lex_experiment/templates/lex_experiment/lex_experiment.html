{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}
  {% trans "LEX Experiment - Otto" %}
{% endblock %}

{% block breadcrumb %}
  {{ block.super }}
  <li class="breadcrumb-item">
    <a href="{% url 'lex_experiment:index' %}">{% trans "LEX Experiment" %}</a>
  </li>
{% endblock %}

{% block content_container %}
  <div class="container pt-5">
    <form method="post"
          enctype="multipart/form-data"
          hx-post="{% url 'lex_experiment:submit_document' %}"
          hx-target="#completed_documents_body"
          hx-swap="innerHTML"
          id="submit_document_form"
          hx-indicator="#spinner"
          onsubmit="document.getElementById('submit').disabled = true;">
      {% csrf_token %}
      <h2 class="h3" id="upload-label">{% trans "Upload Scanned Notice(s) of Appeal" %}</h2>
      <p class="text-secondary mb-4">{% trans "Maximum 2000 files / 300mb total" %}</p>
      <div class="mb-4">
        <input class="form-control"
               id="file-upload-field"
               name="file_upload"
               type="file"
               accept="{{ extensions }}"
               hx-trigger="change"
               hx-select="#submit"
               aria-labelledby="upload-label"
               multiple>
 
      </div>
      <div class="row mb-4">
        <div class="col-auto">
          <button type="submit" class="btn btn-primary" id="submit" disabled="">{% trans "Extract Information" %}</button>
        </div>
        <div class="col" style="margin-top:2px;">
          <div class="spinner text-primary" role="status" id="spinner">
            <span class="visually-hidden">Loading...</span>
            <span class="spinner-border" aria-hidden="true"></span>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="m-5">

    <div id="error_message" role="alert"></div>
 
    <div class="mt-5 {% if not show_output %}d-none{% endif %}"
         id="completed-documents"
         aria-live="polite"
         aria-atomic="true">
      <hr class="m-0">
 
      {# "Completed documents" also includes in-progress now that we're using celery #}
      <h2 class="h3 mt-4 pt-2 mb-3">{% trans "Information extracted" %}</h2>
      <table class="table">
        <thead>

          <tr>
            <th scope="col" width="10%">{% trans "Document" %}</th>
            <th scope="col" width="5%">{% trans "Tax Court of Canada No." %}</th>
            <th scope="col" width="10%">{% trans "Appellant's Name" %}</th>
            <th scope="col" width="10%">{% trans "Appellant's Address" %}</th>
            <th scope="col" width="5%">{% trans "Tax Court Level" %}</th>
            <th scope="col" width="5%">{% trans "Filed Date of NoA" %}</th>
            <th scope="col" width="5%">{% trans "Representative's Name" %}</th>
            <th scope="col" width="10%">{% trans "Representative's Address" %}</th>
            <th scope="col" width="5%">{% trans "Taxation Years" %}</th>
            <th scope="col" width="15%">{% trans "Total Tax Amount" %}</th>
            <th scope="col" width="20%">{% trans "Sections Referred" %}</th>
 
 
          </tr>

        </thead>
        <tbody id="completed_documents_body">
          {% include 'lex_experiment/completed_documents.html' %}
        </tbody>
      </table>
 
    </div>
  </div>

  <script>
function downloadAllFiles() {
  const downloadLinks = document.querySelectorAll('td a.icon-link');
  downloadLinks.forEach((link, index) => {
    setTimeout(() => {
      link.click();
    }, index * 100); // delay is necessary to download multiple files
  });
}
// event listener for when the documents are completed the spinner is hidden and file input is cleared
document.getElementById('completed_documents_body').addEventListener('htmx:afterSwap', function() {
  document.getElementById('file-upload-field').value = '';
  document.getElementById('merge_documents').classList.add('d-none');
  document.getElementById('completed-documents').classList.remove('d-none');
});

// event listener to enable submit button once files has been uploaded
document.getElementById('file-upload-field').addEventListener('change', function() {
  document.getElementById('submit').disabled = false;
  document.getElementById('merge_docs_checkbox').checked = false;
  
  // if more than one documents are uploaded show the merge documents checkbox
  if (this.files.length > 1) {
    document.getElementById('merge_documents').classList.remove('d-none');
  } else {
    document.getElementById('merge_documents').classList.add('d-none');
  }

  // make sure the error button is removed
  document.getElementById('error_message').classList.add('d-none');
});
  </script>
{% endblock %}
