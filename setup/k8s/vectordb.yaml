# CM-8 & CM-9: Defines the application's components within the AKS cluster
# SC-13: Ensure secure key management practices
apiVersion: apps/v1
kind: StatefulSet # Manages the deployment and scaling of stateful applications with stable identities
metadata:
  name: postgres-vector-db
  namespace: otto
spec:
  serviceName: "postgres-vector-service"  # Required for stable network identity
  replicas: 1
  selector:
    matchLabels:
      app: postgres-vector-db
  template:
    metadata:
      labels:
        app: postgres-vector-db
        tier: backend
    spec:
      containers:
        - name: postgres-vector-db
          image: pgvector/pgvector:pg16
          imagePullPolicy: IfNotPresent
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: azure-keyvault-secrets
                  key: vectordbpasswordkey
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: otto-configmap
                  key: VECTORDB_NAME
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: otto-configmap
                  key: VECTORDB_USER
            - name: POSTGRES_MAX_CONNECTIONS
              value: "500"
          ports:
            - containerPort: 5432
          resources:
            requests:
              cpu: "500m"
              memory: "4Gi"
            limits:
              cpu: "500m"
              memory: "4Gi"
          volumeMounts:
            - name: postgres-vector-storage
              mountPath: /var/lib/postgresql/data
              subPath: postgres
            - name: secrets
              mountPath: "/mnt/secrets-store"
              readOnly: true
      volumes:
        - name: secrets
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: "azure-keyvault"
  volumeClaimTemplates:
  - metadata:
      name: postgres-vector-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "otto-managed-csi"
      resources:
        requests:
          storage: 32Gi

---

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: pgvector-autoscaler
  namespace: otto
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres-vector-db
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70

---

apiVersion: v1
kind: Service # Exposes the Postgres vector database to other components within the cluster
metadata:
  name: postgres-vector-service
  namespace: otto
spec:
  type: ClusterIP
  selector:
    app: postgres-vector-db
  ports:
  - port: 5432
    targetPort: 5432

# ---

# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: pgbouncer-vector-config
#   namespace: otto
# data:
#   pgbouncer.ini: |
#     [databases]
#     * = host=postgres-vector-service port=5432

#     [pgbouncer]
#     listen_addr = 0.0.0.0
#     listen_port = 6432
#     auth_type = md5
#     auth_file = /etc/pgbouncer/userlist.txt
#     pool_mode = transaction
#     max_client_conn = 1000
#     default_pool_size = 100
#     reserve_pool_size = 50
#     reserve_pool_timeout = 5
#     server_reset_query = DISCARD ALL
#     server_check_query = select 1
#     server_check_delay = 30
#     ignore_startup_parameters = extra_float_digits

#   userlist.txt: |
#     "$(POSTGRES_USER)" "$(POSTGRES_PASSWORD)"

# ---

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: pgbouncer-vector
#   namespace: otto
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: pgbouncer-vector
#   template:
#     metadata:
#       labels:
#         app: pgbouncer-vector
#     spec:
#       containers:
#       - name: pgbouncer
#         image: edoburu/pgbouncer:1.18.0
#         ports:
#         - containerPort: 6432
#         env:
#         - name: POSTGRES_USER
#           valueFrom:
#             configMapKeyRef:
#               name: otto-configmap
#               key: VECTORDB_USER
#         - name: POSTGRES_PASSWORD
#           valueFrom:
#             secretKeyRef:
#               name: azure-keyvault-secrets
#               key: vectordbpasswordkey
#         volumeMounts:
#         - name: pgbouncer-config
#           mountPath: /etc/pgbouncer
#         resources:
#           requests:
#             cpu: "500m"
#             memory: "512Mi"
#           limits:
#             cpu: "500m"
#             memory: "512Mi"
#       volumes:
#       - name: pgbouncer-config
#         configMap:
#           name: pgbouncer-vector-config

# ---

# apiVersion: v1
# kind: Service
# metadata:
#   name: pgbouncer-vector-service
#   namespace: otto
# spec:
#   selector:
#     app: pgbouncer-vector
#   ports:
#     - protocol: TCP
#       port: 6432
#       targetPort: 6432
